@page "/weeklyplanner"
@inject JsonFileStorageService StorageService

<PageTitle>Planificador Semanal - GoalGrid</PageTitle>

<div class="weekly-planner-container">
    <h3 class="planner-title">Planificador Semanal de Metas</h3>

    <div class="weekly-navigation">
        <button class="btn btn-primary" @onclick="PreviousWeek">Semana Anterior</button>
        <span class="current-week-display">Semana: @StartDate.ToString("dd MMM") - @EndDate.ToString("dd MMM yyyy")</span>
        <button class="btn btn-primary" @onclick="NextWeek">Semana Siguiente</button>
    </div>

    <div class="week-grid">
        @foreach (var day in DaysOfWeek)
        {
            <div class="day-column">
                <div class="day-header">
                    <h4>@day.Date.ToString("ddd d")</h4>
                </div>
                <div class="tasks-list">
                    @foreach (var task in GetTasksForDay(day.Date))
                    {
                        <div class="task-item @(task.IsCompleted ? "completed" : "")">
                            <input type="checkbox" @bind="task.IsCompleted" @bind:after="() => UpdateTaskStatus(task)" />
                            <span class="task-description">@task.Description</span>
                            <button class="btn btn-danger btn-sm delete-task-btn" @onclick="(() => RemoveTask(day.Date, task))">X</button>
                        </div>
                    }

                    <div class="add-task-form">
                        <input type="text" @bind="NewTaskDescription[day.Date]"
                               placeholder="Nueva tarea..."
                               @onkeyup="@((KeyboardEventArgs e) => HandleAddTask(e, day.Date))" />
                        <button class="btn btn-success btn-sm" @onclick="(() => AddTask(day.Date))">Añadir</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private Dictionary<DateTime, List<DailyTask>> WeeklyTasks { get; set; } = new Dictionary<DateTime, List<DailyTask>>();
    private Dictionary<DateTime, string> NewTaskDescription = new Dictionary<DateTime, string>();
    private DateTime CurrentDate { get; set; } = DateTime.Today;
    private DateTime StartDate => GetStartOfWeek(CurrentDate);
    private DateTime EndDate => StartDate.AddDays(6);
    private List<(DateTime Date, DayOfWeek DayOfWeek)> DaysOfWeek { get; set; } = new List<(DateTime Date, DayOfWeek DayOfWeek)>();

    protected override async Task OnInitializedAsync()
    {
        var loadedTasks = await StorageService.LoadTasksAsync();
        if (loadedTasks != null)
        {
            WeeklyTasks = loadedTasks;
        }
        InitializeWeekDisplay();
    }

    private void InitializeWeekDisplay()
    {
        DaysOfWeek.Clear();
        var weekStart = StartDate;
        for (int i = 0; i < 7; i++)
        {
            var date = weekStart.AddDays(i).Date;
            DaysOfWeek.Add((date, date.DayOfWeek));
            if (!NewTaskDescription.ContainsKey(date))
            {
                NewTaskDescription[date] = "";
            }
            if (!WeeklyTasks.ContainsKey(date))
            {
                WeeklyTasks[date] = new List<DailyTask>();
            }
        }
    }

    private void PreviousWeek()
    {
        CurrentDate = CurrentDate.AddDays(-7);
        InitializeWeekDisplay();
    }

    private void NextWeek()
    {
        CurrentDate = CurrentDate.AddDays(7);
        InitializeWeekDisplay();
    }

    private List<DailyTask> GetTasksForDay(DateTime date)
    {
        return WeeklyTasks.GetValueOrDefault(date.Date, new List<DailyTask>());
    }

    private async Task AddTask(DateTime date)
    {
        string description = NewTaskDescription[date.Date];
        if (!string.IsNullOrWhiteSpace(description))
        {
            var newTask = new DailyTask { Description = description, IsCompleted = false };
            WeeklyTasks[date.Date].Add(newTask);
            NewTaskDescription[date.Date] = "";

            await StorageService.SaveTasksAsync(WeeklyTasks);
        }
    }

    private async Task HandleAddTask(KeyboardEventArgs e, DateTime date)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await AddTask(date);
        }
    }

    private async Task UpdateTaskStatus(DailyTask task)
    {
        await StorageService.SaveTasksAsync(WeeklyTasks);
    }

    private async Task RemoveTask(DateTime date, DailyTask taskToRemove)
    {
        if (WeeklyTasks.ContainsKey(date.Date))
        {
            WeeklyTasks[date.Date].Remove(taskToRemove);
            await StorageService.SaveTasksAsync(WeeklyTasks);
        }
    }

    private DateTime GetStartOfWeek(DateTime date)
    {
        int diff = (7 + (date.DayOfWeek - DayOfWeek.Monday)) % 7;
        return date.AddDays(-1 * diff).Date;
    }
}

<style>
    .weekly-planner-container {
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    .planner-title {
        text-align: center;
        margin-bottom: 25px;
        color: #333;
    }

    .weekly-navigation {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 20px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .current-week-display {
        font-size: 1.2em;
        font-weight: bold;
        color: #555;
    }

    .week-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .day-column {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        min-height: 250px;
    }

    .day-header {
        text-align: center;
        margin-bottom: 15px;
        color: #007bff;
        font-weight: bold;
    }

    .tasks-list {
        flex-grow: 1;
    }

    .task-item {
        display: flex;
        align-items: center;
        background-color: #fff;
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        transition: background-color 0.3s ease;
    }

        .task-item.completed {
            background-color: #e6ffe6;
            text-decoration: line-through;
            color: #777;
        }

        .task-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

    .task-description {
        flex-grow: 1;
        word-break: break-word;
    }

    .delete-task-btn {
        margin-left: 10px;
        padding: 2px 8px;
        font-size: 0.8em;
    }

    .add-task-form {
        display: flex;
        gap: 5px;
        margin-top: 15px;
    }

        .add-task-form input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
</style>